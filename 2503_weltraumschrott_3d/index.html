<head>
  <style>
    body {
      margin: 0;
    }

    #time-log {
      position: absolute;
      font-size: 12px;
      font-family: sans-serif;
      padding: 5px;
      border-radius: 3px;
      background-color: rgba(200, 200, 200, 0.1);
      color: lavender;
      bottom: 10px;
      right: 10px;
    }
  </style>

  <script src="//unpkg.com/globe.gl"></script>
  <!-- <script src="../../dist/globe.gl.js"></script> -->
</head>

<body>
  <div id="chart"></div>
  <div id="time-log"></div>

  <script type="module">
    import * as satellite from 'https://esm.sh/satellite.js';
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7';

    const EARTH_RADIUS_KM = 6371; // km
    const TIME_STEP = 3 * 1000; // 3 seconds per frame
    const satSize = 80; // Satellite size scaling factor
    const velocity = 7.8; // Approximate km/s (LEO satellites)
    let satData = [];

    const world = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .showGraticules(true)
      .objectLabel(d => `${d.name} (${d.group})`)
      .objectLat(d => d.position?.lat)
      .objectLng(d => d.position?.lng)
      .objectAltitude(d => d.position?.altitude);

    setTimeout(() => {
      // Set globe rotation speed
      world.controls().autoRotate = true;
      world.controls().autoRotateSpeed = velocity / 24; // mins/orbit (at 60fps)
    });

    const satObjScale = satSize * world.getGlobeRadius() / EARTH_RADIUS_KM / 2;
    const satGeometry = new THREE.SphereGeometry(1, 16, 8);

    const groupMaterials = {};
    const groupColor = d3.scaleOrdinal(d3.schemeCategory10);

    world.objectThreeObject(d => {
      if (!groupMaterials[d.group]) {
        // Cache materials
        groupMaterials[d.group] = new THREE.MeshLambertMaterial({
          color: groupColor(d.group),
          transparent: true,
          opacity: 0.7
        });
      }

      const obj = new THREE.Mesh(satGeometry, groupMaterials[d.group]);
      obj.scale.set(satObjScale, satObjScale, satObjScale);
      return obj;
    });

    // Size existing satellites
    world.objectsData().forEach(d => {
      if (d.__threeObj) {
        d.__threeObj.scale.set(satObjScale, satObjScale, satObjScale);
      }
    });

    let time = new Date();

    function updateTime() {
      time = new Date(+time + velocity * 1000);

      // Update satellite position data
      const gmst = satellite.gstime(time);
      satData.forEach(d => {
        const eciPos = satellite.propagate(d.satrec, time).position;
        if (eciPos) {
          const gdPos = satellite.eciToGeodetic(eciPos, gmst);
          d.position = {
            lat: satellite.radiansToDegrees(gdPos.latitude),
            lng: satellite.radiansToDegrees(gdPos.longitude),
            altitude: gdPos.height / EARTH_RADIUS_KM // Globe radius units
          };
        }
      });

      world.objectsData(satData);
      requestAnimationFrame(updateTime);
    }

    updateTime(); // Start updating time

    const width = window.innerWidth;
    const height = window.innerHeight;
    world.width(width).height(height);

    fetch('250226_full-catalog-spacetrack_only_debakmpkmrb.txt')
      .then(r => r.text())
      .then(rawData => {
        const tleData = rawData
          .replace(/\r/g, '')
          .split(/\n(?=[^12])/)
          .filter(d => d)
          .map(tle => tle.split('\n'));

        satData = tleData.map(([name, ...tle]) => ({
          satrec: satellite.twoline2satrec(...tle),
          name: name.trim().replace(/^0 /, '')
        })).filter(d => !!satellite.propagate(d.satrec, new Date()).position);

        world.objectsData(satData);
      });
  </script>
</body>
